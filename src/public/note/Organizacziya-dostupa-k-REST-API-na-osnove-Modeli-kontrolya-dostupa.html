  
    <html>
      <head>
        <meta charset="utf-8">
        <title>Организация доступа к REST API на основе Модели контроля доступа</title>
        <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">
        <meta name="format-detection" content="telephone=no">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="MobileOptimized" content="176">
        <meta name="HandheldFriendly" content="True">
        <meta name="robots" content="index, follow">
        <meta name="description" content="Разграничение доступа к Node.js web-приложению согласно прав пользователей с использованием библиотеки Casbin">
        <meta property="og:site_name" content="inscriptum">
        <meta property="og:type" content="article">
        <meta property="og:title" content="Организация доступа к REST API на основе Модели контроля доступа">
        <meta property="og:description" content="Разграничение доступа к Node.js web-приложению согласно прав пользователей с использованием библиотеки Casbin">
        <meta property="og:image" content="https://res.cloudinary.com/inscriptum/image/upload/v1643849721/blob_h7l1sn.png">
        <meta property="article:published_time" content="2022-02-03T01:10:22.209+00:00">
        <meta property="article:modified_time" content="2022-02-04T07:09:12.943Z">
        <meta property="article:author" content="denis.sumbaev@gmail.com">
        <meta name="twitter:card" content="summary">
        <meta name="twitter:title" content="Организация доступа к REST API на основе Модели контроля доступа">
        <meta name="twitter:description" content="Разграничение доступа к Node.js web-приложению согласно прав пользователей с использованием библиотеки Casbin">
        <meta name="twitter:image" content="https://res.cloudinary.com/inscriptum/image/upload/v1643849721/blob_h7l1sn.png">
        <style>@font-face{font-family:"Inter";font-style:normal;font-weight:100 900;font-display:swap;src:url(/fonts/inter/UcC73FwrK3iLTeHuS_fvQtMwCp50KnMa0ZL7W0Q5n-wU.woff2) format("woff2");unicode-range:U+0400-045F,U+0490-0491,U+04B0-04B1,U+2116}@font-face{font-family:"Inter";font-style:normal;font-weight:100 900;font-display:swap;src:url(/fonts/inter/UcC73FwrK3iLTeHuS_fvQtMwCp50KnMa1ZL7W0Q5nw.woff2) format("woff2");unicode-range:U+0000-00FF,U+0131,U+0152-0153,U+02BB-02BC,U+02C6,U+02DA,U+02DC,U+2000-206F,U+2074,U+20AC,U+2122,U+2191,U+2193,U+2212,U+2215,U+FEFF,U+FFFD}@font-face{font-family:"JetBrainsMono";font-style:normal;font-weight:400;font-display:swap;src:url(/fonts/jetbrainsmono/tDbY2o-flEEny0FZhsfKu5WU4zr3E_BX0PnT8RD8yKxTPlOTk6OThhvAWV8.woff) format("woff");unicode-range:U+0400-045F,U+0490-0491,U+04B0-04B1,U+2116}@font-face{font-family:"JetBrainsMono";font-style:normal;font-weight:400;font-display:swap;src:url(/fonts/jetbrainsmono/tDbY2o-flEEny0FZhsfKu5WU4zr3E_BX0PnT8RD8yKxTOlOTk6OThhvA.woff) format("woff");unicode-range:U+0000-00FF,U+0131,U+0152-0153,U+02BB-02BC,U+02C6,U+02DA,U+02DC,U+2000-206F,U+2074,U+20AC,U+2122,U+2191,U+2193,U+2212,U+2215,U+FEFF,U+FFFD}html{font-family:sans-serif}@supports(font-variation-settings: normal){html{font-family:"Inter var",sans-serif}}.container{max-width:800px}</style>
        <link rel="shortcut icon" type="image/png" href="favicon.png">
        <link href="/css/note.css" rel="stylesheet">
        <link href="/css/custom_editor_fonts.css" rel="stylesheet">
      </head>
      <body>
        <article>
          <section><h1 data-placeholder="Title" data-label="Title">Организация доступа к REST API на основе Модели контроля доступа </h1><p data-placeholder="Summary of the text" data-label="Summary" role="definition">Разграничение доступа к Node.js web-приложению согласно прав пользователей с использованием библиотеки Casbin</p><p data-placeholder="Take a notes"></p><figure><img src="https://res.cloudinary.com/inscriptum/image/upload/v1643849721/blob_h7l1sn.png" alt=""><figcaption>Авторизация пользователя</figcaption></figure><p>В рамках задачи разграничения доступа к API можно выделить три основных пункта:</p><ol><li><p><strong>Модель контроля доступа.</strong></p></li><li><p><strong>Алгоритм (правило, политика) определения доступности метода API для пользователя.</strong></p></li><li><p><strong>Способ реализации</strong>: самописный инструмент, готовая библиотека, отдельный сервис SAAS, FAAS и т.д.</p></li></ol><h3>Модель контроля доступа</h3><p>Как правило при выборе Модели контроля доступа рассматриваю:</p><ul><li><p><a target="_blank" rel="noopener noreferrer nofollow" href="https://en.wikipedia.org/wiki/Access-control_list">access-control list (ACL)</a>;</p></li><li><p><a target="_blank" rel="noopener noreferrer nofollow" href="https://en.wikipedia.org/wiki/Role-based_access_control">role-based access control (RBAC)</a>;</p></li><li><p><a target="_blank" rel="noopener noreferrer nofollow" href="https://en.wikipedia.org/wiki/Attribute-based_access_control">attribute-based access control (ABAC)</a>.</p></li></ul><p>В общем случае <strong>ACL</strong> хорошо подходят для систем с небольшим количеством пользователей и сущностей системы потому как <strong>определяют прямое соответствие между пользователем и доступными объектами</strong>. </p><p><strong>RBAC</strong> <strong>оперирует ролями вместо отдельных пользователей</strong>. При этом пользователи могут входить в одну или более групп. </p><p><strong>ABAC</strong> подразумевает работу не с сущностями системы (ресурсами), а <strong>проверку отдельных атрибутов этих сущностей</strong>. К примеру, ABAC это когда доступ дается к объекту на основе информации об авторе объекта.</p><p><span>Приведенные выше модели ни в коем случае не являются исчерпывающими, и даже для умеренно сложной системы </span><strong><span>может потребоваться сочетание моделей</span></strong><span>.</span></p><p>Для большинства многопользовательских систем удобной будет модель RBAC так как позволяет распределять права на основе групп. При этом необходимо учитывать специфику и планы по развитию.</p><p>Выбрать какую-либо одну модель мы можем только если границы и функции системы чётко определены и не будут изменяться. В остальных случаях оптимальным будет фокус на наиболее подходящих моделях с архитектурой, способной на дальнейшее расширение.</p><p></p><h3>Определение доступности метода API</h3><p>Если механизм разграничения прав создается для нового приложения, т.е. самой API ещё нет, то это не является проблемой. Мы можем <strong>определить контракт и следовать ему</strong>. Скажем в модели RBAC определяем для группы author возможность читать и писать объекты article. При этом договариваемся, что для чтения используем HTTP метод GET, а для записи PUT. Или мы можем добавлять префиксы к URL и на основе них понимать о сущности и типе действия.</p><p>Более сложная ситуация связана с реализацией для существующего API. При этом чаще всего изменение самой API крайне нежелательно. <strong>В самом худшем случае нужно описать взаимодействие с каждым методом API для каждой группы.</strong> Компромиссным решением является: </p><ol><li><p>Наличие общих проверок по правилам, которым удовлетворяет основная масса API методов.</p></li><li><p>Специфические проверки для отдельных API методов.</p></li></ol><p>В этом случае может потребоваться сочетать разные модели проверки прав доступа.</p><p></p><h3>Реализации проверки прав доступа</h3><p>Использование сторонних сервисов, таких как <a target="_blank" rel="noopener noreferrer nofollow" href="https://www.keycloak.org/">keycloak</a> является не столько техническим, сколько организационным выбором.</p><p>Самописный инструмент - это диаметрально противоположное решение. Способ затратный и сопряжённый с рисками. В большинстве случаев его использование обосновано только при отсутствии доступных готовых решений или при необходимости соблюдения ряда дополнительных требований и правил (опять же организационный выбор).</p><p><strong>Оптимальным, при отсутствия явных противопоказаний, является использование готовых библиотек</strong>. Этот подход наиболее сбалансирован с точки зрения затрат и гибкости.</p><p></p><h4>Поиск существующих Node.js библиотек</h4><p>В OpenSource существует ряд библиотек для разграничения доступа, ниже представлены три из них:</p><table><colgroup><col style="width: 166px;"><col><col></colgroup><tbody><tr><th colspan="1" rowspan="1" colwidth="166"><p>Наименование</p></th><th colspan="1" rowspan="1"><p>Модель контроля доступа </p></th><th colspan="1" rowspan="1"><p>Способ описания прав доступа</p></th></tr><tr><td colspan="1" rowspan="1" colwidth="166"><p><a target="_blank" rel="noopener noreferrer nofollow" href="https://github.com/stalniy/casl"><span>CASL</span></a></p></td><td colspan="1" rowspan="1"><p>ABAC</p></td><td colspan="1" rowspan="1"><p>С помощью объектов в коде приложения</p></td></tr><tr><td colspan="1" rowspan="1" colwidth="166"><p><a target="_blank" rel="noopener noreferrer nofollow" href="https://github.com/onury/accesscontrol">Access Control</a></p></td><td colspan="1" rowspan="1"><p>RBAC, ABAC</p></td><td colspan="1" rowspan="1"><p>JSON</p></td></tr><tr><td colspan="1" rowspan="1" colwidth="166"><p><a target="_blank" rel="noopener noreferrer nofollow" href="https://github.com/casbin">Casbin</a></p></td><td colspan="1" rowspan="1"><p>ACL, RBAC, ABAC, смешанная</p></td><td colspan="1" rowspan="1"><p>PERM</p></td></tr></tbody></table><p>Остановимся на Casbin как наиболее универсальной библиотеке, использующей дополнительную абстракцию над моделями доступа. Благодаря файлу конфигурации основанному на метамоделе <strong>PERM (Policy, Effect, Request, Matchers) </strong>переключение механизма авторизации заключается в изменении конфигурации.</p></section><section><h3>Пример приложения с разграничением прав доступа на основе ролей</h3><p></p><p>Допустим, что у нас есть API сервис написанный на платформе Node.js, который состоит из двух контроллеров и нескольких методов.</p><pre><code autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"><div class="l"><span class="hljs-keyword">import</span> http <span class="hljs-keyword">from</span> <span class="hljs-string">'http'</span>;</div><div class="l"></div><div class="l"><span class="hljs-comment">//#region SERVER</span></div><div class="l"></div><div class="l"><span class="hljs-keyword">const</span> hostname = <span class="hljs-string">'127.0.0.1'</span>;</div><div class="l"><span class="hljs-keyword">const</span> port = <span class="hljs-number">3005</span>;</div><div class="l"></div><div class="l"><span class="hljs-keyword">const</span> server = http.<span class="hljs-title function_">createServer</span>(<span class="hljs-function">(</span><span class="hljs-params">request, response</span>) =&gt; {</div><div class="l">  <span class="hljs-title function_">authMiddleware</span>(request, response);</div><div class="l"></div><div class="l">  <span class="hljs-keyword">switch</span> (<span class="hljs-literal">true</span>) {</div><div class="l">    <span class="hljs-keyword">case</span> request.<span class="hljs-property">url</span>.<span class="hljs-title function_">startsWith</span>(<span class="hljs-string">'/article'</span>):</div><div class="l">      <span class="hljs-title function_">articleController</span>(request, response);</div><div class="l">      <span class="hljs-keyword">break</span>;</div><div class="l">    <span class="hljs-keyword">case</span> request.<span class="hljs-property">url</span>.<span class="hljs-title function_">startsWith</span>(<span class="hljs-string">'/admin_panel'</span>):</div><div class="l">      <span class="hljs-title function_">adminController</span>(request, response);</div><div class="l">      <span class="hljs-keyword">break</span>;</div><div class="l"></div><div class="l">    <span class="hljs-attr">default</span>:</div><div class="l">      <span class="hljs-title function_">notFound</span>(request, response);</div><div class="l">      <span class="hljs-keyword">break</span>;</div><div class="l">  }</div><div class="l">});</div><div class="l"></div><div class="l">server.<span class="hljs-title function_">listen</span>(port, hostname, <span class="hljs-function">() =&gt;</span> {</div><div class="l">  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`Server running at http://</span><span class="hljs-subst">${hostname}</span>:<span class="hljs-subst">${port}</span>/`);</div><div class="l">});</div><div class="l"></div><div class="l"><span class="hljs-comment">//#endregion SERVER</span></div></code></pre><p></p><pre><code autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"><div class="l"><span class="hljs-comment">//#region CONTROLLERS</span></div><div class="l"></div><div class="l"><span class="hljs-keyword">function</span> <span class="hljs-title function_">articleController</span>(<span class="hljs-params">req, res</span>) {</div><div class="l">  <span class="hljs-keyword">if</span> (req.<span class="hljs-property">method</span> === <span class="hljs-string">'GET'</span> &amp;&amp; req.<span class="hljs-property">url</span> === <span class="hljs-string">'/article'</span>) {</div><div class="l">    res.<span class="hljs-property">statusCode</span> = <span class="hljs-number">200</span>;</div><div class="l">    res.<span class="hljs-title function_">setHeader</span>(<span class="hljs-string">'Content-Type'</span>, <span class="hljs-string">'text/plain'</span>);</div><div class="l">    res.<span class="hljs-title function_">end</span>(<span class="hljs-string">'Read an article'</span>);</div><div class="l">    <span class="hljs-keyword">return</span>;</div><div class="l">  }</div><div class="l"></div><div class="l">  <span class="hljs-keyword">if</span> (req.<span class="hljs-property">method</span> === <span class="hljs-string">'POST'</span> &amp;&amp; req.<span class="hljs-property">url</span> === <span class="hljs-string">'/article/find'</span>) {</div><div class="l">    res.<span class="hljs-property">statusCode</span> = <span class="hljs-number">200</span>;</div><div class="l">    res.<span class="hljs-title function_">setHeader</span>(<span class="hljs-string">'Content-Type'</span>, <span class="hljs-string">'text/plain'</span>);</div><div class="l">    res.<span class="hljs-title function_">end</span>(<span class="hljs-string">'Find an article by filter'</span>);</div><div class="l">    <span class="hljs-keyword">return</span>;</div><div class="l">  }</div><div class="l"></div><div class="l">  <span class="hljs-keyword">if</span> (req.<span class="hljs-property">method</span> === <span class="hljs-string">'POST'</span> &amp;&amp; req.<span class="hljs-property">url</span> === <span class="hljs-string">'/article/write'</span>) {</div><div class="l">    res.<span class="hljs-property">statusCode</span> = <span class="hljs-number">200</span>;</div><div class="l">    res.<span class="hljs-title function_">setHeader</span>(<span class="hljs-string">'Content-Type'</span>, <span class="hljs-string">'text/plain'</span>);</div><div class="l">    res.<span class="hljs-title function_">end</span>(<span class="hljs-string">'Write a new article'</span>);</div><div class="l">    <span class="hljs-keyword">return</span>;</div><div class="l">  }</div><div class="l"></div><div class="l">  <span class="hljs-title function_">notFound</span>(req, res);</div><div class="l">}</div><div class="l"></div><div class="l"><span class="hljs-keyword">function</span> <span class="hljs-title function_">adminController</span>(<span class="hljs-params">req, res</span>) {</div><div class="l">  <span class="hljs-keyword">if</span> (req.<span class="hljs-property">method</span> === <span class="hljs-string">'GET'</span> &amp;&amp; req.<span class="hljs-property">url</span> === <span class="hljs-string">'/admin_panel'</span>) {</div><div class="l">    res.<span class="hljs-property">statusCode</span> = <span class="hljs-number">200</span>;</div><div class="l">    res.<span class="hljs-title function_">setHeader</span>(<span class="hljs-string">'Content-Type'</span>, <span class="hljs-string">'text/plain'</span>);</div><div class="l">    res.<span class="hljs-title function_">end</span>(<span class="hljs-string">'Admin panel'</span>);</div><div class="l">    <span class="hljs-keyword">return</span>;</div><div class="l">  }</div><div class="l"></div><div class="l">  <span class="hljs-keyword">if</span> (req.<span class="hljs-property">method</span> === <span class="hljs-string">'PUT'</span> &amp;&amp; req.<span class="hljs-property">url</span> === <span class="hljs-string">'/admin_panel/author'</span>) {</div><div class="l">    res.<span class="hljs-property">statusCode</span> = <span class="hljs-number">200</span>;</div><div class="l">    res.<span class="hljs-title function_">setHeader</span>(<span class="hljs-string">'Content-Type'</span>, <span class="hljs-string">'text/plain'</span>);</div><div class="l">    res.<span class="hljs-title function_">end</span>(<span class="hljs-string">'Create a new author'</span>);</div><div class="l">    <span class="hljs-keyword">return</span>;</div><div class="l">  }</div><div class="l"></div><div class="l">  <span class="hljs-title function_">notFound</span>(req, res);</div><div class="l">}</div><div class="l"></div><div class="l"><span class="hljs-keyword">function</span> <span class="hljs-title function_">notFound</span>(<span class="hljs-params">req, res</span>) {</div><div class="l">  res.<span class="hljs-property">statusCode</span> = <span class="hljs-number">404</span>;</div><div class="l">  res.<span class="hljs-title function_">end</span>();</div><div class="l">}</div><div class="l"></div><div class="l"><span class="hljs-comment">//#endregion CONTROLLERS</span></div><div class="l"></div></code></pre><p>У нас уже есть middleware в которой проверяется токен пользователя.</p><pre><code autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"><div class="l"><span class="hljs-comment">//#region MIDDLEWARE</span></div><div class="l"></div><div class="l"><span class="hljs-keyword">function</span> <span class="hljs-title function_">authMiddleware</span>(<span class="hljs-params">req, res</span>) {</div><div class="l">  <span class="hljs-comment">// Get user token</span></div><div class="l">  <span class="hljs-comment">// const token = req.headers['authorization'];</span></div><div class="l">  <span class="hljs-comment">// Validate token etc...</span></div><div class="l"></div><div class="l">  <span class="hljs-comment">// Get user name and groups from the token</span></div><div class="l">  <span class="hljs-comment">// for simplification we will use values direct from headers</span></div><div class="l">  <span class="hljs-keyword">const</span> name = req.<span class="hljs-property">headers</span>[<span class="hljs-string">'name'</span>];</div><div class="l">  <span class="hljs-keyword">const</span> groups = req.<span class="hljs-property">headers</span>[<span class="hljs-string">'groups'</span>];</div><div class="l"></div><div class="l">  <span class="hljs-keyword">if</span> (name  <span class="hljs-literal">null</span> || groups  <span class="hljs-literal">null</span>) {</div><div class="l">    res.<span class="hljs-property">statusCode</span> = <span class="hljs-number">401</span>;</div><div class="l">    res.<span class="hljs-title function_">end</span>(<span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>({ <span class="hljs-attr">message</span>: <span class="hljs-string">'Unauthorized'</span> }));</div><div class="l">  }</div><div class="l">}</div><div class="l"></div><div class="l"><span class="hljs-comment">//#endregion MIDDLEWARE</span></div></code></pre><p>По условиям задачи у нас будет три группы: <code>admin</code>, <code>author</code>, <code>user</code>. Первой доступно всё, вторая может работать только со статьями, а последняя подразумевает ограниченный доступ (только на чтение) к статьям. Каждый пользователь может обладать от одной до нескольких групп (в системе подразумевается появление специальных групп доступа к отдельным ресурсам).</p><p>Переходим к реализации проверки доступа на основе групп пользователя с помощью библиотеки Casbin. Первое, что требуется это указать конфигурацию (CONF).</p><pre><code autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"><div class="l">[request_definition]</div><div class="l">r <span class="hljs-operator">=</span> sub, obj, act</div><div class="l"></div><div class="l">[policy_definition]</div><div class="l">p <span class="hljs-operator">=</span> sub, obj, act</div><div class="l"></div><div class="l">[role_definition]</div><div class="l">g <span class="hljs-operator">=</span> , </div><div class="l">g2 <span class="hljs-operator">=</span> , </div><div class="l"></div><div class="l">[policy_effect]</div><div class="l">e <span class="hljs-operator">=</span> <span class="hljs-keyword">some</span>(<span class="hljs-keyword">where</span> (p.eft <span class="hljs-operator">==</span> allow))</div><div class="l"></div><div class="l">[matchers]</div><div class="l">m <span class="hljs-operator">=</span> g(r.sub, p.sub) <span class="hljs-operator">&amp;&amp;</span> (g2(r.obj, p.obj) <span class="hljs-operator">||</span> keyMatch(r.obj, p.obj)) <span class="hljs-operator">&amp;&amp;</span> keyMatch(r.act, p.act)</div></code></pre><p>Из особенностей:</p><ul><li><p>используются две группы <code>g</code> и <code>g2</code>. В рамках первой будем задавать группы пользователей, а в рамках второй - группы ресурсов.</p></li><li><p>применяются функции <code>keyMatch</code> это <span>даст возможность указывать в политиках не полные имена объектов (obj) и действий</span> (act), а использовать паттерны.</p></li></ul><p>Важно отметить, что это только одна из возможных конфигураций под решение текущей задачи. Документация у Casbin подробная с множественными примерами и более подробную информацию о параметрах и функциях можно узнать в ней.</p><p>В общем случае для REST API за контракт удобно принять следующие утверждения:</p><ul><li><p>HTTP метод GET означает чтение, а остальные - запись;</p></li><li><p>первый уровень в URL (котроллер) - это сущность в системе. К примеру, <code>http://127.0.0.1:3005/article/list</code> подразумевает выполнение действия над сущностью <code>article</code>.</p></li></ul><p>Руководствуясь конфигурацией и этими правилами создадим политику.</p><pre><code autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"><div class="l">p, <span class="hljs-keyword">group</span>:<span class="hljs-keyword">user</span>, entity:article, read</div><div class="l">p, <span class="hljs-keyword">group</span>:author, entity:article, write</div><div class="l">p, <span class="hljs-keyword">group</span>:admin, <span class="hljs-operator">*</span>, <span class="hljs-operator">*</span></div><div class="l"></div><div class="l">p, <span class="hljs-keyword">group</span>:<span class="hljs-keyword">user</span>, <span class="hljs-operator">/</span>article<span class="hljs-operator">/</span>find, <span class="hljs-operator">*</span></div><div class="l"></div><div class="l">g, <span class="hljs-keyword">group</span>:author, <span class="hljs-keyword">group</span>:<span class="hljs-keyword">user</span></div><div class="l">g, <span class="hljs-keyword">group</span>:admin, <span class="hljs-keyword">group</span>:author</div><div class="l"></div><div class="l">g2, <span class="hljs-operator">/</span>article, entity:article</div><div class="l">g2, <span class="hljs-operator">/</span>article<span class="hljs-comment">/*, entity:article</span></div></code></pre><p>Явным исключением выделяется <code>p, group:user, /article/find, *</code>, что обосновано методом в API <code>http://127.0.0.1:3005/article/find</code>, который хоть и выполняет только чтение, но использует POST.</p><p>В остальном политика соответствует описанному выше контракту.</p><p>Осталось добавить логику проверки в middleware.</p><pre><code autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"><div class="l"><span class="hljs-keyword">const</span> sub = name; <span class="hljs-comment">// use a user name as subject</span></div><div class="l"><span class="hljs-keyword">const</span> obj = req.<span class="hljs-property">url</span>; <span class="hljs-comment">// use URL as object</span></div><div class="l"><span class="hljs-keyword">const</span> act = req.<span class="hljs-property">method</span> === <span class="hljs-string">'GET'</span> ? <span class="hljs-string">'read'</span> : <span class="hljs-string">'write'</span>; <span class="hljs-comment">// GET is 'read', others are 'write'</span></div><div class="l"></div><div class="l"><span class="hljs-keyword">const</span> enforcer = <span class="hljs-keyword">await</span> <span class="hljs-title function_">newEnforcer</span>(<span class="hljs-title function_">newModel</span>(model), <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringAdapter</span>(policy));</div><div class="l"></div><div class="l">enforcer.<span class="hljs-title function_">addNamedMatchingFunc</span>(<span class="hljs-string">'g2'</span>, <span class="hljs-title class_">Util</span>.<span class="hljs-property">keyMatchFunc</span>);</div><div class="l"></div><div class="l"><span class="hljs-keyword">const</span> <span class="hljs-title function_">addGroupsToUser</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params">sub, groups</span>) =&gt; {</div><div class="l">  <span class="hljs-keyword">await</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">all</span>(groups.<span class="hljs-title function_">map</span>(<span class="hljs-function">(</span><span class="hljs-params">group</span>) =&gt; enforcer.<span class="hljs-title function_">addRoleForUser</span>(sub, <span class="hljs-attr">group</span>:${group})));</div><div class="l">};</div><div class="l"></div><div class="l"><span class="hljs-keyword">await</span> <span class="hljs-title function_">addGroupsToUser</span>(name, groups);</div><div class="l"></div><div class="l"><span class="hljs-keyword">const</span> isPermitted = <span class="hljs-keyword">await</span> enforcer.<span class="hljs-title function_">enforce</span>(sub, obj, act);</div><div class="l"></div><div class="l"><span class="hljs-keyword">if</span> (!isPermitted) {</div><div class="l">  res.<span class="hljs-property">statusCode</span> = <span class="hljs-number">403</span>;</div><div class="l">  res.<span class="hljs-title function_">end</span>(<span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>({ <span class="hljs-attr">message</span>: <span class="hljs-string">'Forbidden'</span> }));</div><div class="l">}</div><div class="l"></div></code></pre><p>На строке <code>enforcer.addNamedMatchingFunc('g2', Util.keyMatchFunc);</code> происходит добавление функции <code>keyMatchFunc</code> для группы <code>g2</code> . Это необходимо сделать для того, чтобы мы могли указывать конструкции вида <code>/article/*</code> для второй группы.</p><p>Второй особенностью в коде является функция <code>addGroupsToUser</code>. Суть её работы состоит в соотнесении текущего пользователя с его группами на уровне механизма авторизации Casbin.</p><p>Для проверки авторизации отправим следующие запросы чтобы проверить, что доступ есть:</p><pre><code autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"><div class="l">curl http://127.0.0.1:3005/article -i -H <span class="hljs-string">"name: bob"</span> -H <span class="hljs-string">"groups: user"</span></div><div class="l"></div><div class="l"></div><div class="l">curl http://127.0.0.1:3005/article/find -X POST -i -H <span class="hljs-string">"name: bob"</span> -H <span class="hljs-string">"groups: user"</span></div><div class="l"></div><div class="l"></div><div class="l">curl http://127.0.0.1:3005/article -i -H <span class="hljs-string">"name: alice"</span> -H <span class="hljs-string">"groups: user,author"</span></div><div class="l"></div><div class="l"></div><div class="l">curl http://127.0.0.1:3005/article/write -X POST -i -H <span class="hljs-string">"name: alice"</span> -H <span class="hljs-string">"groups: user,author"</span></div><div class="l"></div><div class="l"></div><div class="l">curl http://127.0.0.1:3005/article/write -X POST -i -H <span class="hljs-string">"name: tom"</span> -H <span class="hljs-string">"groups: admin,author"</span></div><div class="l"></div><div class="l"></div><div class="l">curl http://127.0.0.1:3005/admin_panel/author -X PUT -i -H <span class="hljs-string">"name: tom"</span> -H <span class="hljs-string">"groups: admin,author"</span></div><div class="l"></div><div class="l"></div><div class="l">curl http://127.0.0.1:3005/admin_panel -i -H <span class="hljs-string">"name: tom"</span> -H <span class="hljs-string">"groups: admin,author"</span></div></code></pre><p>И несколько, для проверки запрета:</p><pre><code autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"><div class="l">curl http://127.0.0.1:3005/article/write -X POST -i -H <span class="hljs-string">"name: bob"</span> -H <span class="hljs-string">"groups: user"</span></div><div class="l"></div><div class="l">curl http://127.0.0.1:3005/admin_panel -i -H <span class="hljs-string">"name: alice"</span> -H <span class="hljs-string">"groups: user,author"</span></div></code></pre><p></p><p>В итоге достигнут желаемый результат - <code>admin</code> имеет доступ ко всему, <code>author</code> может работать только со статьями, а <code>user</code> обладает ограниченным доступом только на чтение. Полный код примера можно найти по <a target="_blank" rel="noopener noreferrer nofollow" href="https://gist.github.com/sumbad/48bce0a19d9bfed6bec0a87689592dad">этой ссылке</a>.</p><p></p><h4>Примечания</h4><p></p><p><strong>NB 1:</strong> Альтернативой middleware может служить обработчик на каждом отдельном методе API. К примеру, через декоратор при OOP архитектуре, как это <a target="_blank" rel="noopener noreferrer nofollow" href="https://github.com/typestack/routing-controllers#using-authorization-features">показано в библиотеке routing-controllers</a>. К плюсам можно отнести лучшую читаемость кода, его декларативность, возможность передачи дополнительных параметров. К минусам - больше правок существующего кода, обязательность декоратора для каждого метода.</p><p><strong>NB 2:</strong> У Casbin есть песочница, в которой можно проверить разные конфигурации и политики к ним без написания кода.</p></section><section><h3>Материалы</h3><ol><li><p>Теория</p><ul><li><p><a target="_blank" rel="noopener noreferrer nofollow" href="https://habr.com/ru/company/custis/blog/248649/">Подходы к контролю доступа: RBAC vs. ABAC</a></p></li><li><p><a target="_blank" rel="noopener noreferrer nofollow" href="https://habr.com/ru/company/custis/blog/258861/">Знакомство с XACML — стандартом для Attribute-Based Access Control</a></p></li></ul></li><li><p>Инструменты</p><ul><li><p><a target="_blank" rel="noopener noreferrer nofollow" href="https://github.com/onury/accesscontrol">https://github.com/onury/accesscontrol</a></p></li><li><p><a target="_blank" rel="noopener noreferrer nofollow" href="https://github.com/stalniy/casl">https://github.com/stalniy/casl</a></p></li><li><p><a target="_blank" rel="noopener noreferrer nofollow" href="https://github.com/casbin">https://github.com/casbin</a></p></li><li><p><a target="_blank" rel="noopener noreferrer nofollow" href="https://www.libtrends.info/npm-compare/cancan-vs-casbin-vs-casl-vs-passport">https://www.libtrends.info/npm-compare/cancan-vs-casbin-vs-casl-vs-passport</a></p></li></ul></li><li><p>Практика</p><ul><li><p><a target="_blank" rel="noopener noreferrer nofollow" href="https://www.osohq.com/post/adding-authorization-nodejs-app-beyond-role-based-access-control">Adding Authorization to a Node.js App – Beyond Role-Based Access Control (RBAC)</a></p></li><li><p><a target="_blank" rel="noopener noreferrer nofollow" href="https://medium.com/wesionary-team/understanding-casbin-with-different-access-control-model-configurations-faebc60f6da5">Understanding Casbin with different Access Control Model Configurations</a></p></li><li><p><a target="_blank" rel="noopener noreferrer nofollow" href="https://dev.to/matttyler/how-to-add-role-based-access-control-to-your-serverless-http-api-on-aws-17bk">How to Add Role-Based-Access-Control to Your Serverless HTTP API on AWS</a></p></li><li><p><a target="_blank" rel="noopener noreferrer nofollow" href="https://www.nearform.com/blog/access-control-node-js-fastify-and-casbin/">Access Control in Node.js with Fastify and Casbin</a></p></li><li><p><a target="_blank" rel="noopener noreferrer nofollow" href="https://habr.com/ru/post/539778/">RBAC? ABAC?.. PERM! Новый подход к авторизации в облачных веб-службах и приложениях</a></p></li><li><p><a target="_blank" rel="noopener noreferrer nofollow" href="https://medium.com/wesionary-team/understanding-casbin-with-different-access-control-model-configurations-faebc60f6da5">Understanding Casbin with different Access Control Model Configurations</a></p></li></ul></li></ol></section>
        </article>
      </body>
      <script type="text/javascript" src="/js/note.js"></script>
    </html>