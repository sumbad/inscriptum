(self.webpackChunkinscriptum=self.webpackChunkinscriptum||[]).push([[8960],{58960:()=>{let e=navigator.userAgent.toLowerCase(),t=(/opera/i.test(e)||/opr/i.test(e),/msie/i.test(e)&&!/opera/i.test(e)||/trident\//i.test(e)||/edge/i.test(e),/edge/i.test(e)&&/opera/i.test(e),/firefox/i.test(e),/chrome/i.test(e)&&/edge/i.test(e),!/chrome/i.test(e)&&/webkit|safari|khtml/i.test(e),/iphone/i.test(e),/ipod/i.test(e),/ipad/i.test(e),/android/i.test(e),/iphone|ipod|ipad|opera mini|opera mobi|iemobile|android/i.test(e)),l=/iphone|ipod|ipad/i.test(e),o=(/opera mini|opera mobi/i.test(e),/opera mini/i.test(e),/mac/i.test(e),Quill.import("blots/inline")),i=Quill.import("blots/block"),s=Quill.import("blots/block/embed"),n=Quill.import("blots/embed"),r=(Quill.import("blots/text"),Quill.import("formats/code-block")),a=Quill.import("formats/list/item"),c=Quill.import("parchment"),d=Quill.import("delta"),u=Quill.import("modules/keyboard");class h extends o{static create(e){let t=super.create(e);e=this.sanitize(e),t.setAttribute("href",e);var l=e.substr(0,1);return"/"!=l&&"#"!=l&&"tg://"!=e.substr(0,5)&&"mailto:"!=e.substr(0,7)&&t.setAttribute("target","_blank"),t}static formats(e){return e.getAttribute("href")}static sanitize(e){return E(e,["http","https","tg","mailto"])?function(e){let t=location,l=document.createElement("a");if(l.href=e,t.origin!=l.origin)return l.href;if(t.pathname!=l.pathname||t.search!=l.search)return l.pathname+l.search+l.hash;if(t.href==l.href)return l.hash||l.pathname+l.search+l.hash;return l.hash}(e):"about:blank"}constructor(e,t){super(e),$(e).on("mouseover",(()=>{showLinkTooltip(this,t)})),$(e).on("mouseout",(function(){hideLinkTooltip()}))}detach(){$(this.domNode).off("mouseover mouseout"),super.detach(),hideLinkTooltip()}format(e,t){if(e!==this.statics.blotName||!t)return super.format(e,t);t=this.constructor.sanitize(t),this.domNode.setAttribute("href",t),this.domNode.setAttribute("data-title",t)}}h.blotName="link",h.tagName="a",Quill.register(h);class p extends n{}p.blotName="textBreak",p.tagName="br",p.className="inline",Quill.register(p);class m extends i{replace(e){e.children.forEach((e=>{e instanceof p&&e.replaceWith(c.create("text"," "))})),super.replace(e)}insertAt(e,t,l){void 0!==l&&"textBreak"==t?super.insertAt(e,"\n"):super.insertAt(e,t,l)}}class f extends m{}class g extends f{static create(e){let t=super.create(e);return t.setAttribute("data-placeholder","Title"),t.setAttribute("data-label","Title"),t}formatAt(e,t,l,o){l===this.constructor.blotName&&super.formatAt(e,t,l,o)}}g.blotName="blockTitle",g.tagName="h1",Quill.register(g);class b extends f{static create(e){let t=super.create(e);return t.setAttribute("data-placeholder","Your name"),t.setAttribute("data-label","Author"),t}formatAt(e,t,l,o){l===this.constructor.blotName?super.formatAt(e,t,l,o):"link"===l&&super.formatAt(0,this.length(),l,o)}}b.blotName="blockAuthor",b.tagName="address",Quill.register(b);class k extends m{optimize(){super.optimize();let e=$(this.domNode).text();e=e.replace(/[\s_]+/g,"-"),e=e.replace(/(^-+|-+$)/g,""),this.domNode.setAttribute("id",e)}formatAt(e,t,l,o){("bold"!==l&&"italic"!==l&&"code"!==l||!o)&&super.formatAt(e,t,l,o)}}k.blotName="blockHeader",k.tagName="h3",Quill.register(k);class v extends k{}v.blotName="blockSubheader",v.tagName="h4",Quill.register(v);class _ extends i{}_.blotName="blockBlockquote",_.tagName="blockquote",Quill.register(_);class x extends i{}x.blotName="blockPullquote",x.tagName="aside",Quill.register(x);class S extends r{replace(e){e.children.forEach((e=>{e instanceof p&&e.replaceWith(c.create("text","\n"))})),super.replace(e)}}S.blotName="code-block",Quill.register(S);class C extends s{}C.blotName="blockDivider",C.tagName="hr",Quill.register(C);class y extends s{static create(e){let t=super.create(e);return t.setAttribute("contenteditable","false"),t}constructor(e,t){super(e),this.domWrapper=document.createElement("div"),this.domCursor=document.createElement("span"),this.domCaption=document.createElement("figcaption"),this.domWrapper.classList.add("figure_wrapper"),this.domCursor.classList.add("cursor_wrapper"),this.domCursor.setAttribute("contenteditable","true"),this.domCaption.classList.add("editable_text"),this.domCaption.setAttribute("data-placeholder","Caption (optional)"),t.caption&&(this.domCaption.innerText=t.caption),this.domNode.appendChild(this.domWrapper),this.domNode.appendChild(this.domCursor),this.domNode.appendChild(this.domCaption),setTimeout((()=>{F(this.domNode)}),1);let l=!1;t.image?(this.appendImgNode(t.image),l=this.uploadData(t.image)):t.video?(this.appendVideoNode(t.video),l=this.uploadData(t.video)):t.embed&&this.appendIframeNode(t.embed),l&&(this.domProgress=document.createElement("div"),this.domProgressBar=document.createElement("div"),this.domProgress.classList.add("file_progress"),this.domProgressBar.classList.add("file_progress_bar"),this.domWrapper.classList.add("loading"),this.domProgress.appendChild(this.domProgressBar),this.domWrapper.appendChild(this.domProgress),this.uploadFile(l)),$(this.domWrapper).click((()=>{if(!this.domNode.classList.contains("focus")){let e=this.offset(_e.scroll);_e.focus(),_e.setSelection(e,0,Quill.sources.USER)}})),$(this.domCursor).keydown((e=>{let t=e.which||e.keyCode;if(t==u.keys.BACKSPACE){let t=this.offset(_e.scroll);_e.deleteText(t,this.length(),Quill.sources.USER),_e.setSelection(t-1,0,Quill.sources.USER),e.preventDefault()}else if(t==u.keys.ENTER){let t=this.offset(_e.scroll)+this.length();_e.focus(),_e.insertText(t,"\n",Quill.sources.USER),_e.setSelection(t,0,Quill.sources.USER),e.preventDefault()}})),$(this.domCursor).on("paste",(e=>{e.stopPropagation(),e.preventDefault()})),$(this.domCaption).keydown((e=>{let t=e.which||e.keyCode,l=$(e.target);if(t==u.keys.ENTER){if(e.shiftKey)return;let t=l.selection("getPos"),o=l.val();if(t.start!=t.end)o=o.substr(0,t.start)+o.substr(t.end),l.val(o).selection("setPos",{start:o.length,end:o.length});else if(t.end==o.length){let e=this.offset(_e.scroll)+this.length();_e.focus(),_e.insertText(e,"\n",Quill.sources.USER),_e.setSelection(e,0,Quill.sources.USER)}e.preventDefault()}else if(t==u.keys.DOWN||t==u.keys.TAB||t==u.keys.RIGHT){let t=l.selection("getPos"),o=l.val();if(t.start==t.end&&t.end==o.length){let t=this.offset(_e.scroll)+this.length();_e.focus(),_e.setSelection(t,0,Quill.sources.USER),e.preventDefault()}}else if(t==u.keys.LEFT||t==u.keys.UP){let t=l.selection("getPos");if(t.start==t.end&&0===t.start){let t=this.offset(_e.scroll)-1;_e.focus(),_e.setSelection(t,0,Quill.sources.USER),e.preventDefault()}}})),$(this.domCaption).on("paste",(e=>{e.stopPropagation()})),$(this.domCaption).on("keyup drop change input textInput paste cut",(e=>{$(this.domCaption).toggleClass("empty",!e.target.value),autosize.update(e.target),H()})),$(this.domCaption).click((e=>{e.target.focus()}))}appendImgNode(e){let t=document.createElement("img");return t.setAttribute("src",this.sanitize(e)),this.domWrapper.appendChild(t),t}appendVideoNode(e){let t=document.createElement("video");return t.setAttribute("src",this.sanitize(e)),t.setAttribute("preload","auto"),t.setAttribute("controls","controls"),t.addEventListener("loadeddata",(function(){this.mozHasAudio||this.webkitAudioDecodedByteCount||this.audioTracks&&this.audioTracks.length||(this.setAttribute("autoplay","autoplay"),this.setAttribute("loop","loop"),this.setAttribute("muted","muted"),this.removeAttribute("controls"),this.play())})),this.domWrapper.appendChild(t),t}appendIframeNode(e){let t=document.createElement("div"),l=document.createElement("div"),o=document.createElement("iframe");return t.classList.add("iframe_wrap"),t.appendChild(l),l.classList.add("iframe_helper"),l.style.paddingTop="56.25%",l.appendChild(o),o.setAttribute("src",this.sanitize(e)),o.setAttribute("width","640"),o.setAttribute("height","360"),o.setAttribute("frameborder","0"),o.setAttribute("allowtransparency","true"),o.setAttribute("allowfullscreen","true"),o.setAttribute("scrolling","no"),this.domWrapper.appendChild(t),t}uploadFile(e){!function(e,t,l,o){var i=new FormData;i.append("file",q(e)),$.ajax({url:"/upload",type:"POST",data:i,cache:!1,dataType:"json",processData:!1,contentType:!1,xhr:function(){var e=new XMLHttpRequest;return e.upload.addEventListener("progress",(function(e){e.lengthComputable&&t&&t(e.loaded,e.total)})),e},beforeSend:function(e){t&&t(0,1)},success:function(e){if(e.error)return o&&o(e.error);$.each(e,(function(e,t){l&&l(t)}))},error:function(e){return o&&o("Network error")}})}(e,((e,t)=>{let l=0;t&&e&&(l=100*e/t,l=Math.min(100,l)),this.domProgressBar.style.width=l+"%"}),(t=>{if(t){let l=this.sanitize(t.src);if("video/"==e.type.substr(0,6)){this.domWrapper.querySelector("video").setAttribute("src",l)}else{this.domWrapper.querySelector("img").setAttribute("src",l)}this.domWrapper.classList.remove("loading"),H()}}),(e=>(_e.deleteText(this.offset(_e.scroll),this.length(),Quill.sources.SILENT),H(),D(e))))}uploadData(e){let t=null;return!!(t=e.match(/^data:(image\/gif|image\/jpe?g|image\/png|video\/mp4);base64,(.*)$/))&&{type:t[1],base64_data:t[2]}}sanitize(e){return E(e,["http","https","data"])?e:"//:0"}static value(e){let t={caption:""},l=e.querySelector("img");l&&(t.image=l.src);let o=e.querySelector("video");o&&(t.video=o.src);let i=e.querySelector("iframe");i&&(t.embed=i.src);let s=e.querySelector("figcaption");if(s){let e=s.querySelector(".editable_input");t.caption=e?e.value:s.innerText}return t}focus(){this.domNode.classList.add("focus")}blur(){this.domNode.classList.remove("focus")}_index(e,t){if(e===this.domCaption)return 0;let l=0;return e.nodeType==e.TEXT_NODE&&(l+=t>=0?t:e.data.length),e.previousSibling?l+this._index(e.previousSibling,-1):e.parentNode?l+this._index(e.parentNode,-1):0}_position(e,t){if(e.nodeType==e.TEXT_NODE)return t<=e.data.length?[e,t]:[null,t-=e.data.length];{let l=e.firstChild;for(;l;){let e=null;if([e,t]=this._position(l,t),e)return[e,t];l=l.nextSibling}return[e,t]}}update(e){this.domCursor.innerHTML=""}index(e,t){return 0}position(e,t){return[this.domCursor,0]}}y.blotName="blockFigure",y.tagName="figure",Quill.register(y);class N extends Quill{formatLine(...e){super.formatLine(...e),this.updateSelection()}formatText(...e){super.formatText(...e),this.updateSelection()}updateSelection(e){if(this.hasFocus()){e=e||this.constructor.sources.SILENT;let t=this.getSelection(!0);this.setSelection(++t.index,t.length,e),this.setSelection(--t.index,t.length,e)}}}function E(e,t){let l=document.createElement("a");l.href=e;let o=l.href.slice(0,l.href.indexOf(":"));return t.indexOf(o)>-1}function A(e){let t;if((t=e.match(/^(https?):\/\/(www\.)?youtube\.com\/watch.*v=([a-zA-Z0-9_-]+)/i))||(t=e.match(/^(https?):\/\/(www\.)?youtu\.be\/([a-zA-Z0-9_-]+)/i)))return{embed:"/embed/youtube?url="+encodeURIComponent(e)};if(t=e.match(/^(https?):\/\/(www\.)?vimeo\.com\/(\d+)/i))return{embed:"/embed/vimeo?url="+encodeURIComponent(e)};if(t=e.match(/^(https?):\/\/(www\.|mobile\.)?twitter\.com\/(.+)\/status\/(\d+)/i))return{embed:"/embed/twitter?url="+encodeURIComponent(e)};if(t=e.match(/^(https?):\/\/(t\.me|telegram\.me|telegram\.dog)\/([a-zA-Z0-9_]+)\/(\d+)/i))return{embed:"/embed/telegram?url="+encodeURIComponent(e)};if(t=e.match(/^data:(image\/gif|image\/jpe?g|image\/png|video\/mp4);base64,(.*)$/))return"video/"==t[1].substr(0,6)?{video:e}:{image:e};if(t=e.match(/^(https?):\/\/\S+/i)){let l=document.createElement("a");if(l.href=e,l.pathname.match(/\.(jpe?g|png|gif|mp4)$/i))return"mp4"==t[1]?{video:e}:{image:e}}return!1}function w(){$(".placeholder_once").removeAttr("data-placeholder").removeClass("placeholder_once empty")}function Q(e){e.scroll.descendants(i,0,e.scroll.length()).forEach((e=>{if(e.domNode.hasAttribute("data-placeholder")){let t=$(e.domNode).text();$(e.domNode).toggleClass("empty",!t)}}))}function L(e){let[t,l]=e.scroll.lines();if(t instanceof s)e.updateContents((new d).insert("\n",{blockTitle:!0}).insert("\n",{blockAuthor:!0}),Quill.sources.SILENT);else if(t instanceof g||e.formatLine(0,1,{blockTitle:!0},Quill.sources.SILENT),l){if(l instanceof s){let t=l.offset(e.scroll);e.updateContents((new d).retain(t).insert("\n",{blockAuthor:!0}),Quill.sources.SILENT)}else if(!(l instanceof b)){let t=l.offset(e.scroll);e.formatLine(t,1,{blockAuthor:!0},Quill.sources.SILENT)}}else{let t=e.scroll.length();e.updateContents((new d).retain(t).insert("\n",{blockAuthor:!0}),Quill.sources.SILENT)}let[,,o]=e.scroll.lines();if(o){let t=o.offset(e.scroll),l=e.scroll.length()-t;e.scroll.descendants(f,t,l).forEach((t=>{let l=t.offset(e.scroll),o=t.length(),i=t.constructor.blotName;e.formatText(l,o,i,!1,Quill.sources.SILENT)}))}else{let t=e.scroll.length();e.insertText(t,"\n",Quill.sources.SILENT)}let i=e.scroll.lines();i.forEach(((e,t)=>{"P"==e.domNode.tagName&&(3==i.length&&2==t?e.domNode.setAttribute("data-placeholder","Your story..."):e.domNode.removeAttribute("data-placeholder"))}))}function R(e){let[t]=_e.scroll.descendant(y,e.index);_e.scroll.descendants(y,0,_e.scroll.length()).forEach((e=>{t!==e&&e.blur()})),t&&(t.focus(),he(),pe())}function P(e,t){if("image/jpg"==e.type||"image/jpeg"==e.type)return loadImage(e,(l=>{if("error"===l.type)t(e);else if(l.toBlob)l.toBlob((function(e){t(e)}),e.type);else{var o=l.toDataURL(e.type),i={type:e.type,base64_data:o.split(",")[1]};t(q(i))}}),{canvas:!0,orientation:!0});t(e)}function q(e){for(var t=atob(e.base64_data),l=[],o=0;o<t.length;o++)l.push(t.charCodeAt(o));return new Blob([new Uint8Array(l)],{type:e.type})}function I(e){if(!e.tagName)return e.data;let t={tag:e.tagName.toLowerCase()};if(e.attributes.length){t.attrs={};for(var l=0;l<e.attributes.length;l++){let o=e.attributes[l];t.attrs[o.name]=o.value}}if(e.childNodes.length){t.children=[];for(l=0;l<e.childNodes.length;l++)t.children.push(I(e.childNodes[l]))}return t}function U(e){let t=$(_e.scroll.domNode);$("textarea,input",t).map((function(){this.setAttribute("data-value",this.value)}));let l=t.clone();return $("textarea,input",t).map((function(){this.removeAttribute("data-value")})),$("textarea,input",l).map((function(){this.value=this.getAttribute("data-value"),this.removeAttribute("data-value")})),F(l,!1),$("[contenteditable]",l).removeAttr("contenteditable"),$("[data-placeholder]",l).removeAttr("data-placeholder"),$("[data-label]",l).removeAttr("data-label"),$("[data-title]",l).removeAttr("data-title"),$(".editable_text",l).removeClass("editable_text"),$(".focus",l).removeClass("focus"),$(".empty",l).removeClass("empty"),$('[class=""]',l).removeAttr("class"),$(".file_progress",l).remove(),$(".cursor_wrapper",l).remove(),e?($("h1:not(:has(br)),address:not(:has(br))",l).append("<br>"),l.html()):($("h1,address",l).remove(),$("br.inline",l).replaceWith("\n"),{data:JSON.stringify(I(l.get(0)).children),length:l.html().length})}function D(e){ce.text(e),clearTimeout(ce.to),ce.addClass("shown"),ce.to=setTimeout((()=>{ce.removeClass("shown")}),3e3)}function B(){if(K.hasClass("tl_article_saving"))return!1;let e=$("h1",V).text(),t=$("address",V).text(),l=$("address a",V).attr("href")||"";if(e.length<2){clearTimeout(K.to),K.addClass("title_required"),K.to=setTimeout((()=>{K.removeClass("title_required")}),3e3),_e.focus();let[e]=_e.scroll.descendants(g,0,_e.scroll.length());return _e.setSelection(e.offset(),e.length()-1),_e.selection.scrollIntoView(),D("Title is too small")}if($('img[src^="data:"],video[src^="data:"]').length)return D("Upload in progress.\nPlease wait...");let o=U();if(o.length>65536)return D("Content is too big");K.addClass("tl_article_saving"),j(!1);let i="---------------------------TelegraPhBoundary21",s="--"+i+'\r\nContent-Disposition: form-data; name="Data";filename="content.html"\r\nContent-type: plain/text\r\n\r\n'+o.data+"\r\n--"+i+'\r\nContent-Disposition: form-data; name="title"\r\n\r\n'+e+"\r\n--"+i+'\r\nContent-Disposition: form-data; name="author"\r\n\r\n'+t+"\r\n--"+i+'\r\nContent-Disposition: form-data; name="author_url"\r\n\r\n'+l+"\r\n--"+i+'\r\nContent-Disposition: form-data; name="save_hash"\r\n\r\n'+(T.saveHash||"")+"\r\n--"+i+'\r\nContent-Disposition: form-data; name="page_id"\r\n\r\n'+T.pageId+"\r\n--"+i+"--";$.ajax(T.apiUrl+"/save",{contentType:"multipart/form-data; boundary="+i,data:s,type:"POST",dataType:"json",xhrFields:{withCredentials:!0},success:function(e){if(K.removeClass("tl_article_saving"),e.error)return j(!0),D(e.error);!function(e){try{localStorage.removeItem(e)}catch(e){return!1}}("draft"),!T.pageId&&e.path&&(location.href="/"+e.path)},error:function(e){return K.removeClass("tl_article_saving"),j(!0),D("Network error")}})}function z(e){let t=null==e?{}:_e.getFormat(e),l=!!t.blockAuthor,o=!(!t.blockHeader&&!t.blockSubheader),i=!!t["code-block"];if(Z.toggleClass("active",!!t.bold),Z.toggleClass("disabled",l||o||i),J.toggleClass("active",!!t.italic),J.toggleClass("disabled",l||o||i),te.toggleClass("active",!!t.blockHeader),te.toggleClass("disabled",l),le.toggleClass("active",!!t.blockSubheader),le.toggleClass("disabled",l),oe.toggleClass("active",!(!t.blockBlockquote&&!t.blockPullquote)),oe.toggleClass("pullquote",!!t.blockPullquote),oe.toggleClass("disabled",l),null!=e){let t=_e.scroll.descendants(h,e.index,e.length);ee.toggleClass("active",!!t.length)}else ee.toggleClass("active",!1);ee.toggleClass("disabled",i)}function H(){if(!xe)return!1;if(!T.pageId){var e=U(!0);if(xe!=e)return xe=e,function(e,t){try{return localStorage.setItem(e,t),!!localStorage.getItem(e)}catch(e){return!1}}("draft",e)}return!1}function W(){return!T.pageId&&function(e){try{return localStorage.getItem(e)}catch(e){return!1}}("draft")}function O(){return K.hasClass("tl_article_edit")}function F(e,t){void 0===t&&(t=O()),t?$(".editable_text:not(:has(.editable_input))",e).map((function(){let e=this.innerText,t=document.createElement("textarea");return t.classList.add("editable_input"),t.setAttribute("tabindex","-1"),t.setAttribute("rows","1"),t.value=e,e||this.classList.add("empty"),$(this).empty().append(t),autosize(t),t})):$(".editable_text > .editable_input",e).map((function(){let e=this.value,t=this.parentNode;return $(t).empty().text(e),t}))}function j(e){if(K.toggleClass("tl_article_edit",e),F(),window.quill&&(_e.enable(e),e&&_e.focus()),!e){var t=$("h1",V).text(),l=$("address",V).text(),o=$("address a",V).attr("href");$("h1",M).text(t),$("address a",M).text(l),o?$("address a",M).attr("href",o):$("address a",M).removeAttr("href"),hideLinkTooltip(),he(),pe()}}$(".tl_page");let K=$(".tl_article"),M=$(".tl_article_header"),V=$(".tl_article_content"),X=$("#_tl_tooltip"),G=$("#_tl_blocks"),Y=$("#_tl_link_tooltip"),Z=$("#_bold_button"),J=$("#_italic_button"),ee=$("#_link_button"),te=$("#_header_button"),le=$("#_subheader_button"),oe=$("#_quote_button"),ie=$("#_image_button"),se=$("#_embed_button"),ne=$("#_edit_button"),re=$("#_publish_button"),ae=$(".account"),ce=$("#_error_msg"),de={padding:10,position:t?"bottom":"top",minDelta:5},ue={padding:7,position:"bottom",depend:X,dependPadding:10};function he(){X.removeClass("move_anim shown"),be(Y,null,ue)}function pe(){G.removeClass("shown")}function me(){$(".tl_alert").remove()}function fe(e,t){(t=t||{}).close_btn=t.close_btn||"OK",t.submit_btn=t.submit_btn||!1,t.close=t.close||me,t.submit=t.submit||t.close,me();var l=$('<div class="tl_alert"><main class="tl_alert_message"><section></section><aside class="tl_message_buttons"></aside></main></div>');$("section",l).html(e);var o=$("aside",l);t.close_btn&&$('<button class="button"></button>').html(t.close_btn).click(t.close).appendTo(o);t.submit_btn&&$('<button class="button"></button>').html(t.submit_btn).click((function(){l.addClass("tl_alert_loading"),t.submit()})).appendTo(o);l.appendTo("body")}function ge(e,t,l){if(!t||!t.hasClass("shown"))return!1;e.bottom=e.top+e.height,e.right=e.left+e.width;let o=t,i={top:o._top,bottom:o._top+t.outerHeight(),left:o._left,right:o._left+t.outerWidth()};return!(e.left-i.right>=l||i.left-e.right>=l||e.top-i.bottom>=l||i.top-e.bottom>=l)&&i}function be(e,t,l){if(l=l||{padding:10,position:"top"},null==(t=t||e._range||null))return;let o=_e.getBounds(t),i=$(_e.container).offset(),s={width:e.outerWidth(),height:e.outerHeight()},n=$(window).outerWidth(),r=$(window).outerHeight(),a=document.body.scrollTop,c=9,d=a+9,u=n-s.width-9,h=a+r-s.height-9;s.left=o.left+o.width/2-s.width/2;let p,m=i.left+s.left;if(m<c?s.left=c-i.left:m>u&&(s.left=u-i.left),"top"==l.position){s.top=o.top-s.height-l.padding,p=!1,i.top+s.top<d&&(s.top=o.bottom+l.padding,p=!0)}else if("bottom"==l.position){let e=!1;s.top=o.bottom+l.padding,(e=ge(s,l.depend,l.dependPadding))&&(s.top=e.bottom+l.dependPadding),p=!0,i.top+s.top>h&&(s.top=o.top-s.height-l.padding,(e=ge(s,l.depend,l.dependPadding))&&(s.top=e.top-s.height-l.dependPadding),p=!1)}s.left=Math.round(s.left),s.top=Math.round(s.top),e._range=t,l.minDelta&&Math.abs(s.left-e._left)<l.minDelta&&Math.abs(s.top-e._top)<l.minDelta||(e._left=s.left,e._top=s.top,e.css({left:s.left,top:s.top}).toggleClass("bottom",p))}function ke(e){if(void 0===e&&(e=_e.getSelection()),null==e||!window.quill)return;let t=_e.getBounds(e);G.css({top:t.top+t.height/2})}function ve(e){let t=$(".prompt_input",e),l=$(".close",e);t.off("keydown"),t.off("blur"),l.off("click"),e.show().removeClass("tooltip_prompt"),_e.focus()}X.mouseover((function(e){let t=e.target;"BUTTON"!=e.target.tagName||e.target.classList.contains("disabled")||(X.attr("data-hover",t.id).addClass("hover"),setTimeout((()=>{X.addClass("hover_anim")}),1),clearTimeout(X.to))})),X.mouseout((function(e){"BUTTON"==e.target.tagName&&(X.removeClass("hover"),X.to=setTimeout((()=>{X.removeClass("hover_anim")}),70))})),Z.click((function(e){let t=e.target.classList.contains("active");e.preventDefault();_e.getSelection(!0);_e.format("bold",!t),_e.updateSelection(Quill.sources.API)})),J.click((function(e){let t=e.target.classList.contains("active");e.preventDefault();_e.getSelection(!0);_e.format("italic",!t),_e.updateSelection(Quill.sources.API)})),ee.click((function(e){let t=e.target.classList.contains("active");e.preventDefault();var l=_e.getSelection(!0);if(t){_e.scroll.descendants(h,l.index,l.length).forEach((e=>{let t=e.offset(_e.scroll),l=e.length();_e.formatText(t,l,"link",!1)})),z(l)}else!function(e,t,l){let o=$(".prompt_input",e),i=$(".close",e);o.val("").attr("placeholder",t),o.on("keydown",(function(t){let i=t.which||t.keyCode;if(27==i)ve(e);else if(13==i){let i=o.val();i&&(l&&l(i),t.preventDefault()),ve(e)}})),o.on("blur",(function(){ve(e)})),i.on("click",(function(){ve(e)})),e.show().addClass("tooltip_prompt"),o.focus()}(X,"Paste or type a link...",(function(e){"#"!=(e=e.trim()).substr(0,1)&&"/"!=e.substr(0,1)&&"http://"!=e.substr(0,7)&&"https://"!=e.substr(0,8)&&"tg://"!=e.substr(0,5)&&"mailto:"!=e.substr(0,7)&&(e=e.indexOf("@")>0?"mailto:"+e:"http://"+e),_e.focus(),_e.format("link",e),z(l)}))})),te.click((function(e){let t=e.target.classList.contains("active");e.preventDefault();let l=_e.getSelection(!0);_e.format("blockHeader",!t),_e.scroll.descendants(k,l.index,l.length).forEach((e=>{let t=e.offset(_e.scroll),l=e.length();_e.formatText(t,l,{bold:!1,italic:!1,code:!1},Quill.sources.SILENT)})),_e.updateSelection(Quill.sources.API)})),le.click((function(e){let t=e.target.classList.contains("active");e.preventDefault();let l=_e.getSelection(!0);_e.format("blockSubheader",!t),_e.scroll.descendants(v,l.index,l.length).forEach((e=>{let t=e.offset(_e.scroll),l=e.length();_e.formatText(t,l,{bold:!1,italic:!1,code:!1},Quill.sources.SILENT)})),_e.updateSelection(Quill.sources.API)})),oe.click((function(e){let t=e.target,l=t.classList.contains("active"),o=t.classList.contains("pullquote");e.preventDefault();_e.getSelection(!0);l?_e.format("blockPullquote",!o):_e.format("blockBlockquote",!0),_e.updateSelection(Quill.sources.API)})),ie.click((function(){let e=_e.container.querySelector("input.ql-image[type=file][data-status=ready]");null==e&&(e=document.createElement("input"),e.setAttribute("type","file"),e.setAttribute("accept",l?"image/gif, image/jpeg, image/jpg, image/png":"image/gif, image/jpeg, image/jpg, image/png, video/mp4"),e.classList.add("ql-image"),e.addEventListener("change",(()=>{null!=e.files&&null!=e.files[0]&&P(e.files[0],(t=>{if(_e.fileSizeLimit&&t.size>_e.fileSizeLimit)return _e.fileSizeLimitCallback&&_e.fileSizeLimitCallback();var l=new FileReader;l.onload=function(t){let l=A(t.target.result);if(l){let e=_e.getSelection(!0);_e.updateContents((new d).retain(e.index).delete(e.length).insert({blockFigure:l}),Quill.sources.USER)}else D("Invalid file format");e.value="",e.setAttribute("data-status","ready")},l.readAsDataURL(t)}))})),_e.container.appendChild(e)),e.setAttribute("data-status","busy"),e.click()})),se.click((function(e){let t=_e.getSelection(!0),[l]=_e.scroll.line(t.index);if(l){$(l.domNode).text()||(l.domNode.setAttribute("data-placeholder","Paste a YouTube, Vimeo or Twitter link, and press Enter"),$(l.domNode).addClass("placeholder_once empty"),pe())}})),re.click((function(){B()})),ne.click((function(){j(!0)})),$(window).on("scroll resize",(function(){be(X,null,de),be(Y,null,ue)})),(new Image).src=window.devicePixelRatio>=2?"/images/icons_2x.png?1":"/images/icons.png?1";var _e=function(){let e=W();function t(e,t){return[e,function(e,l){return l.compose((new d).retain(l.length(),t))}]}function l(e){let t=function(e){let[t,l]=n.scroll.line(e);return n.getText(e,t.length()-l)}(e);return!t||"\n"==t}function o(e,t,o){let i,s=t.index;t.length>0&&n.scroll.deleteAt(s,t.length);let r=l(s),a=!1;return[i]=n.scroll.descendant(p,s),i?(!i.prev||i.prev instanceof p)&&(n.scroll.deleteAt(--s,1),a=!0):([i]=n.scroll.descendant(p,s-1),i&&(n.scroll.deleteAt(--s,1),a=!0)),[i]=n.scroll.descendant(m,s),i||a||!e?(n.insertText(s,"\n",Quill.sources.USER),n.setSelection(++s,Quill.sources.USER),(o.format.blockHeader||o.format.blockSubheader||o.format.blockBlockquote||o.format.blockPullquote)&&r&&n.formatLine(s,1,{blockHeader:!1,blockSubheader:!1,blockBlockquote:!1,blockPullquote:!1},Quill.sources.USER)):(n.insertEmbed(s,"textBreak",!0,Quill.sources.USER),[i]=n.scroll.descendant(p,s),!i||i.next||i.prev&&i.prev instanceof p||(n.insertEmbed(++s,"textBreak",!0,Quill.sources.SILENT),n.setSelection(s,0,Quill.sources.SILENT))),n.selection.scrollIntoView(),!1}function s(e){let[t,l]=n.scroll.line(e.index);if(t){let o;if(o=t.domNode.innerText.substr(0,l).match(/(^|\s)((?:https?|tg):\/\/\S+|www\.\S+)$/)){let t=o[2],l=t.length;"www."==t.substr(0,4)&&(t="http://"+t),n.scroll.descendants(h,e.index-l,l).length||n.formatText(e.index-l,l,"link",t,Quill.sources.USER)}}return!0}e&&$("#_tl_editor").html(e);var n=new N("#_tl_editor",{readOnly:!0,fileSizeLimit:5242880,fileSizeLimitCallback:function(){D("File too big (up to 5 MB allowed)")},updatePhoto:P,formats:["bold","italic","underline","strike","code","link","textBreak","blockTitle","blockAuthor","blockHeader","blockSubheader","blockBlockquote","blockPullquote","blockDivider","blockFigure","code-block","list"],modules:{clipboard:{matchers:[t("h2",{blockHeader:!0}),t("h5",{blockSubheader:!0}),t("h6",{blockSubheader:!0}),["img",function(e,t){return e.src&&E(e.src,["http","https","data"])?(new d).insert({blockFigure:{image:e.src,caption:e.alt||""}}):new d}],["video",function(e,t){return e.src&&E(e.src,["http","https","data"])?(new d).insert({blockFigure:{video:e.src}}):new d}],["br",function(e,t){return e.classList.contains("inline")?(new d).insert({textBreak:!0}):t}]]},keyboard:{bindings:{indent:{handler:function(){return!0}},outdent:{handler:function(){return!0}},tab:{key:u.keys.TAB,handler:function(){return!0}},"required enter":{key:u.keys.ENTER,collapsed:!0,shiftKey:null,format:["blockTitle","blockAuthor"],suffix:/^$/,handler:function(e,t){let[l]=this.quill.scroll.descendant(f,e.index);return l&&l.next&&!$(l.next.domNode).text()?(this.quill.setSelection(l.next.offset(this.quill.scroll),0,Quill.sources.USER),!1):(this.quill.insertText(e.index,"\n",Quill.sources.USER),!1)}},"required tab prev":{key:u.keys.TAB,shiftKey:!0,handler:function(e,t){let l=null;if(e.length>0){let t=n.scroll.descendants(i,e.index,e.length);if(1!=t.length)return!0;l=t[0]}else[l]=n.scroll.descendant(i,e.index);if(null!=l&&null!=l.prev&&l.prev instanceof f){let e=l.prev.offset(n.scroll),t=l.prev.length();return n.setSelection(e,t>1?t:0,Quill.sources.USER),!1}return!0}},"required tab next":{key:u.keys.TAB,shiftKey:!1,handler:function(e,t){let l=null;if(e.length>0){let t=n.scroll.descendants(i,e.index,e.length);if(1!=t.length)return!0;l=t[0]}else[l]=n.scroll.descendant(i,e.index);if(null!=l&&l instanceof f&&null!=l.next){let e=l.next.offset(n.scroll);if(l.next instanceof f){let t=l.next.length();n.setSelection(e,t>1?t:0,Quill.sources.USER)}else n.setSelection(e,0,Quill.sources.USER);return!1}return!0}},"no tab":{key:u.keys.TAB,shiftKey:null,handler:function(e,t){return!1}},"detect embed":{key:u.keys.ENTER,collapsed:!0,handler:function(e,t){let[l,o]=n.scroll.line(e.index);if(l){let t,i=l.domNode.innerText.substr(0,o);if(t=i.match(/(^|\s)(https?:\/\/\S+)$/)){let s=t[2];if(n.scroll.descendants(h,e.index-s.length,s.length).length||n.formatText(e.index-s.length,s.length,"link",s,Quill.sources.USER),!i.substr(0,o-s.length).trim().length&&"P"==l.domNode.tagName){let e=A(s);if(e){let t=l.offset(n.scroll);return n.updateContents((new d).retain(t).delete(i.length).insert({blockFigure:e}),Quill.sources.USER),pe(),!1}}}}return!0}},"divider autofill":{key:u.keys.ENTER,collapsed:!0,prefix:/^([-*])\1{2,}$/,handler:function(e,t){let[l,o]=n.scroll.line(e.index);if(l&&"P"==l.domNode.tagName){let e=l.offset(n.scroll),t=(new d).retain(e).delete(l.length()).insert({blockDivider:!0});return l.next||t.insert("\n"),n.updateContents(t,Quill.sources.USER),!1}return!0}},break:{key:u.keys.ENTER,shiftKey:!0,handler:o.bind(null,!0)},enter:{key:u.keys.ENTER,handler:o.bind(null,!1)},"detect link":{key:" ",collapsed:!0,handler:s},"cancel placeholder":{key:u.keys.ESCAPE,handler:function(e,t){return w(),this.quill.updateSelection(Quill.sources.USER),!0}},"list autofill":{key:" ",collapsed:!0,format:{list:!1},prefix:/^(1\.|-|\*)$/,handler:function(e,t){let l=t.prefix.length;this.quill.scroll.deleteAt(e.index-l,l),this.quill.formatLine(e.index-l,1,"list",1===l?"bullet":"ordered",Quill.sources.USER),this.quill.setSelection(e.index-l,Quill.sources.SILENT)}},"pre wrap":{key:192,collapsed:!0,format:{"code-block":!1},prefix:/^``$/,offset:2,handler:function(e,t){let l=t.prefix.length,o=e.index-l;this.quill.scroll.deleteAt(o,l),this.quill.formatLine(o,1,"code-block",!0,Quill.sources.USER),this.quill.setSelection(o,Quill.sources.SILENT)}},code:{key:192,handler:function(e,t){if(!t.collapsed){let l=n.scroll.descendants(i,e.index,e.length);if(l.length>1||1==l.length&&l[0]instanceof r)return this.quill.format("code-block",!t.format["code-block"],Quill.sources.USER),!1;if(n.scroll.descendants(p,e.index,e.length).length)return this.quill.format("code-block",!t.format["code-block"],Quill.sources.USER),!1}if(t.collapsed&&!t.format.code&&!/\s$/.test(t.prefix))return!0;this.quill.format("code",!t.format.code,Quill.sources.USER)}},"figure delete":{key:u.keys.BACKSPACE,collapsed:!0,offset:0,handler:function(e,t){let[l,o]=n.scroll.line(e.index);return!(l&&l.prev&&l.prev instanceof y)||(t.empty&&n.deleteText(e.index,1,Quill.sources.USER),n.setSelection(l.prev.offset(n.scroll)),!1)}},"field backspace":{key:u.keys.BACKSPACE,collapsed:!0,offset:0,handler:function(e,t){let[l,o]=n.scroll.line(e.index);return!(l&&l.prev&&l.prev instanceof f&&$(l.domNode).text().length>0)}}}}}});return n.addContainer(Y.get(0)),n.addContainer(X.get(0)),n.addContainer(G.get(0)),n.on(Quill.events.EDITOR_CHANGE,(function(e,t){if(e!==Quill.events.SELECTION_CHANGE)return;if(!n.isEnabled())return;if(null==t)return;R(t);let[l,o]=n.scroll.descendant(i,t.index);0===t.length?(he(),null==l||l instanceof f||l instanceof _||l instanceof x||l instanceof r||l instanceof a||$(l.domNode).text().length?pe():function(e){if(!O())return;G.addClass("shown"),ke(e)}(t)):(null==l||l instanceof g?he():(!function(e){if(!O())return;X.removeClass("tooltip_prompt"),be(X,e,de),X.hasClass("move_anim")||setTimeout((()=>{X.addClass("move_anim")}),10);X.hasClass("shown")?be(Y,null,ue):setTimeout((()=>{X.addClass("shown"),be(Y,null,ue)}),10)}(t),z(t)),pe());let s=n.getFormat(t);K.toggleClass("title_focused",!(!s.blockTitle&&!s.blockAuthor)),w()})),n.on(Quill.events.TEXT_CHANGE,(function(){n.getSelection();L(n),Q(n),w(),H()})),n.on(Quill.events.TEXT_PASTE,(function(){let e=n.getSelection();e&&s(e)})),n.on(Quill.events.SCROLL_OPTIMIZE,(function(e){e.forEach((e=>{if("childList"==e.type&&!e.addedNodes.length&&e.removedNodes.length){let t=e.previousSibling,l=e.nextSibling;if(!l&&t&&"BR"==t.tagName&&"inline"==t.className){let t=document.createElement("br");t.className="inline",e.target.appendChild(t)}else!l||!t||"BR"==t.tagName&&"inline"==t.className||"BR"!=l.tagName||"inline"!=l.className||l.nextSibling||l.parentNode&&l.parentNode.removeChild(l)}}))})),n.scroll.domNode.setAttribute("dir","auto"),$(document).on("click touchstart",(function(e){let t=e.target;for(;t;){if(t===n.container)return;t=t.parentNode}he(),pe()})),L(n),Q(n),n}(),xe=!1;t&&$(document.body).addClass("mobile"),$.ajax(T.apiUrl+"/check",{data:{page_id:T.pageId},type:"POST",dataType:"json",xhrFields:{withCredentials:!0},success:function(e){if(e.save_hash&&(T.saveHash=e.save_hash),(e.can_edit&&T.saveHash||!T.pageId)&&(e.short_name&&ae.text(e.short_name),K.addClass("tl_article_editable")),!T.pageId&&(K.addClass("tl_article_edit"),!W()&&e.author_name)){if(e.author_url)var t={link:e.author_url};else t={};let[l]=_e.scroll.descendants(b);l&&_e.updateContents((new d).retain(l.offset()).delete(l.length()).insert(e.author_name,t),Quill.sources.USER)}if(e.auth_alert&&e.short_name){var l="Success! You are now logged in as <b>"+e.short_name.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/\'/g,"&#39;").replace(/%/g,"&#37;")+"</b> in this browser.";e.migrate_count>0&&e.migrate_hash?(l+="<br/><br/>",fe(l+="We can also add "+e.migrate_count+" Telegraph page"+(e.migrate_count>1?"s":"")+" from this browser to your account.",{close_btn:"Skip",submit_btn:"Add",submit:function(){var t;t=e.migrate_hash,$.ajax(T.apiUrl+"/migrate",{data:{migrate_hash:t},type:"POST",dataType:"json",xhrFields:{withCredentials:!0},success:function(e){e.migrated_count>0?fe("Added <b>"+e.migrated_count+"</b> Telegraph page"+(e.migrated_count>1?"s":"")+' to your account.<br><br>To see a list of your pages, talk to the <a href="https://t.me/telegraph" target="_blank">@Telegraph</a> bot on Telegram.'):me()}})}})):fe(l)}xe=U(!0),j(O())}})}}]);