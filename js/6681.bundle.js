"use strict";(self.webpackChunkinscriptum=self.webpackChunkinscriptum||[]).push([[6681],{6681:(t,e,i)=>{i.r(e),i.d(e,{FigureBlot:()=>p});var s=i(5039),o=i(3691),r=i(1812),a=i(9367),n=i.n(a),l=i(8770),d=i(6136),u=function(t,e,i,s){return new(i||(i=Promise))((function(o,r){function a(t){try{l(s.next(t))}catch(t){r(t)}}function n(t){try{l(s.throw(t))}catch(t){r(t)}}function l(t){var e;t.done?o(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(a,n)}l((s=s.apply(t,e||[])).next())}))};class p extends o.i2{constructor(t,e){super(t),this.domNode=t,this.domWrapper=document.createElement("div"),this.domCursor=document.createElement("span"),this.domCaption=document.createElement("figcaption"),this.domWrapper.classList.add("figure_wrapper"),this.domCursor.classList.add("cursor_wrapper"),this.domCursor.setAttribute("contenteditable","true"),this.domCaption.classList.add("editable_text"),this.domCaption.setAttribute("data-placeholder","Caption (optional)"),e.caption&&(this.domCaption.innerText=e.caption),this.domNode.appendChild(this.domWrapper),this.domNode.appendChild(this.domCursor),this.domNode.appendChild(this.domCaption),setTimeout((()=>{(0,d.updateEditableText)(this.domNode)}),1);let i=!1;e.image?(this.appendImgNode(e.image),i=this.uploadData(e.image)):e.video?(this.appendVideoNode(e.video),i=this.uploadData(e.video)):e.embed&&this.appendIframeNode(e.embed),i&&(this.domProgress=document.createElement("div"),this.domProgressBar=document.createElement("div"),this.domProgress.classList.add("file_progress"),this.domProgressBar.classList.add("file_progress_bar"),this.domWrapper.classList.add("loading"),this.domProgress.appendChild(this.domProgressBar),this.domWrapper.appendChild(this.domProgress),this.uploadFile(i)),this.domWrapper.onclick=()=>{if(!this.domNode.classList.contains("focus")){let t=this.offset(this.scroll);this.focus(),p.quillSetSelection(t)}},this.domCursor.onkeydown=t=>{let e=t.which||t.keyCode;if(e==r.Z.keys.BACKSPACE){let e=this.offset(this.scroll);p.quillDeleteText(e,this.length()),p.quillSetSelection(e-1),t.preventDefault()}else if(e==r.Z.keys.ENTER){let e=this.offset(this.scroll)+this.length();this.focus(),p.quillInsertText(e,"\n"),p.quillSetSelection(e),t.preventDefault()}},this.domCursor.onpaste=t=>{t.stopPropagation(),t.preventDefault()},this.domCaption.onkeydown=t=>{let e=t.which||t.keyCode,i=t.target;if(e==r.Z.keys.ENTER){if(t.shiftKey)return;let e={start:i.selectionStart,end:i.selectionEnd},s=i.value;if(e.start!=e.end)s=s.substr(0,e.start)+s.substr(e.end),i.setSelectionRange(s.length,s.length);else if(e.end==s.length){let t=this.offset(this.scroll)+this.length();this.focus(),p.quillInsertText(t,"\n"),p.quillSetSelection(t)}t.preventDefault()}else if(e==r.Z.keys.DOWN||e==r.Z.keys.TAB||e==r.Z.keys.RIGHT){let e={start:i.selectionStart,end:i.selectionEnd},s=i.value;if(e.start==e.end&&e.end==s.length){let e=this.offset(this.scroll)+this.length();this.focus(),p.quillSetSelection(e,0),t.preventDefault()}}else if(e==r.Z.keys.LEFT||e==r.Z.keys.UP){let e={start:i.selectionStart,end:i.selectionEnd};if(e.start==e.end&&0===e.start){let e=this.offset(this.scroll)-1;this.focus(),p.quillSetSelection(e,0),t.preventDefault()}}};const s=t=>{null!==t&&null!==t.target&&(this.domCaption.classList.toggle("empty",!t.target.value),n().update(t.target),p.draftSave())};this.domCaption.onpaste=t=>{t.stopPropagation(),s(t)},this.domCaption.onkeyup=s,this.domCaption.ondrop=s,this.domCaption.onchange=s,this.domCaption.oninput=s,this.domCaption.oncut=s,this.domCaption.onclick=t=>{t.target&&t.target.focus()}}static create(t){let e=super.create(t);return e.setAttribute("contenteditable","false"),e}appendImgNode(t){let e=document.createElement("img");return e.setAttribute("src",this.sanitize(t)),this.domWrapper.appendChild(e),e}appendVideoNode(t){let e=document.createElement("video");return e.setAttribute("src",this.sanitize(t)),e.setAttribute("preload","auto"),e.setAttribute("controls","controls"),e.addEventListener("loadeddata",(function(){this.mozHasAudio||this.webkitAudioDecodedByteCount||this.audioTracks&&this.audioTracks.length||(this.setAttribute("autoplay","autoplay"),this.setAttribute("loop","loop"),this.setAttribute("muted","muted"),this.removeAttribute("controls"),this.play())})),this.domWrapper.appendChild(e),e}appendIframeNode(t){let e=document.createElement("div"),i=document.createElement("div"),s=document.createElement("iframe");return e.classList.add("iframe_wrap"),e.appendChild(i),i.classList.add("iframe_helper"),i.style.paddingTop="56.25%",i.appendChild(s),s.setAttribute("src",this.sanitize(t)),s.setAttribute("width","640"),s.setAttribute("height","360"),s.setAttribute("frameborder","0"),s.setAttribute("allowtransparency","true"),s.setAttribute("allowfullscreen","true"),s.setAttribute("scrolling","no"),this.domWrapper.appendChild(e),e}uploadFile(t){this.uploadFileStart(t,((t,e)=>{let i=0;e&&t&&(i=100*t/e,i=Math.min(100,i)),this.domProgressBar.style.width=i+"%"}),(e=>{if(e){let i=this.sanitize(e.src);if("video/"==t.type.substr(0,6)){let t=this.domWrapper.querySelector("video");t&&t.setAttribute("src",i)}else{let t=this.domWrapper.querySelector("img");t&&t.setAttribute("src",i)}this.domWrapper.classList.remove("loading"),p.draftSave()}}),(t=>(p.quillDeleteText(this.offset(this.scroll),this.length(),s.Z.sources.SILENT),p.draftSave(),(0,d.showError)(t))))}uploadData(t){let e=null;return!!(e=t.match(/^data:(image\/gif|image\/jpe?g|image\/png|video\/mp4);base64,(.*)$/))&&{type:e[1],base64_data:e[2]}}sanitize(t){return(0,d.sanitize)(t,["http","https","data"])?t:"//:0"}static value(t){let e={caption:""},i=t.querySelector("img");i&&(e.image=i.src);let s=t.querySelector("video");s&&(e.video=s.src);let o=t.querySelector("iframe");o&&(e.embed=o.src);let r=t.querySelector("figcaption");if(r){let t=r.querySelector(".editable_input");e.caption=t?t.value:r.innerText}return e}focus(){this.domNode.classList.add("focus")}blur(){this.domNode.classList.remove("focus")}_index(t,e){if(t===this.domCaption)return 0;let i=0;return t.nodeType==t.TEXT_NODE&&(i+=e>=0?e:t.data.length),t.previousSibling?i+this._index(t.previousSibling,-1):t.parentNode?i+this._index(t.parentNode,-1):0}_position(t,e){if(t.nodeType==t.TEXT_NODE)return e<=t.data.length?[t,e]:[null,e-=t.data.length];{let i=t.firstChild;for(;i;){let t=null;if([t,e]=this._position(i,e),t)return[t,e];i=i.nextSibling}return[t,e]}}update(t){this.domCursor.innerHTML=""}index(t,e){return 0}position(t,e){return[this.domCursor,0]}uploadFileStart(t,e,i,s){return u(this,void 0,void 0,(function*(){try{const s=yield(0,l.uploadFileService)((0,d.uploadDataToBlob)(t),e);i&&i(s)}catch(t){s&&s("Network error")}}))}}}}]);